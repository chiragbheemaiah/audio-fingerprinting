<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Audio Fingerprinting" }}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        /* ColorHunt palette */
        body {
            background-color: #EFECE3;
            color: #000000;
            font-family: 'Inter', Arial, sans-serif;
        }

        .navbar {
            background-color: #4A70A9;
        }

        .navbar-brand {
            color: #EFECE3 !important;
            font-weight: 600;
        }

        h1,
        h5 {
            color: #4A70A9;
        }

        .muted {
            color: #8FABD4;
        }

        .card {
            background-color: #FFFFFF;
            border: 1px solid #8FABD4;
            border-radius: 12px;
        }

        .card-header {
            background-color: #8FABD4;
            border-bottom: 1px solid #4A70A9;
            color: #000000;
            font-weight: 600;
        }

        .btn-primary {
            background: #4A70A9;
            border-color: #4A70A9;
            color: #EFECE3;
        }

        .btn-primary:hover {
            background: #3a5a87;
        }

        .btn-outline-dark {
            color: #000000;
            border-color: #000000;
        }

        .dropzone {
            border: 2px dashed #8FABD4;
            border-radius: 10px;
            padding: 1.25rem;
            cursor: pointer;
            color: #8FABD4;
            background-color: #FFFFFF;
            text-align: center;
            display: block;
        }

        .dropzone.dragover {
            border-color: #4A70A9;
            background-color: rgba(74, 112, 169, 0.1);
        }

        .footer {
            color: #8FABD4;
            margin-top: 40px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Nav -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">Taptic • Audio Fingerprinting</a>
        </div>
    </nav>

    <main class="container py-5">

        <!-- Uploaded Songs (server-rendered via Jinja) -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">Uploaded Songs</div>
                <div class="card-body">
                    {% if uploaded_files and uploaded_files|length > 0 %}
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th class="text-start">Filename</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in uploaded_files %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td class="text-start">{{ f.name }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="muted mb-0">No uploaded songs yet.</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Hero -->
        <div class="row g-4 align-items-center">
            <div class="col-lg-7">
                <h1 class="fw-bold mb-2">Build your audio library and run queries</h1>
                <p class="muted mb-0">
                    Upload reference audio to your library, submit a query clip, and see predicted matches below.
                </p>
            </div>
        </div>

        <!-- Uploads -->
        <div class="row g-4 mt-2">
            <!-- Add to Library -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">Add audio to library</div>
                    <div class="card-body">
                        <form id="form-library" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label">Choose audio file</label>
                                <label id="dz-library" class="dropzone" for="file-library">Drop file here or click to
                                    browse</label>
                                <input id="file-library" class="d-none" type="file" name="audio" accept="audio/*"
                                    required />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Optional label</label>
                                <input id="label-library" name="label" type="text" class="form-control"
                                    placeholder="e.g., Fire Alarm, Whistle" />
                            </div>

                            <button class="btn btn-primary w-100" type="submit">Upload & Save</button>
                        </form>
                        <div id="alert-library" class="alert mt-3 d-none" role="alert"></div>
                    </div>
                </div>
            </div>

            <!-- Query -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">Run a query</div>
                    <div class="card-body">
                        <form id="form-query" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label">Choose query audio</label>
                                <label id="dz-query" class="dropzone" for="file-query">Drop file here or click to
                                    browse</label>
                                <input id="file-query" class="d-none" type="file" name="audio" accept="audio/*"
                                    required />
                            </div>

                            <!-- Query status indicator -->
                            <div id="query-status" class="alert alert-info d-none" role="status" aria-live="polite">
                                <span class="spinner-border spinner-border-sm me-2" role="status"
                                    aria-hidden="true"></span>
                                Submitting query… waiting for response
                            </div>

                            <button id="btn-submit-query" class="btn btn-primary w-100" type="submit">
                                Submit Query
                            </button>
                        </form>
                        <div id="alert-query" class="alert mt-3 d-none" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictions -->
        <div class="card mt-5">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Predictions</h5>
                <button id="btn-clear-results" class="btn btn-sm btn-outline-dark">Clear</button>
            </div>
            <div class="card-body">
                <div id="empty-state" class="text-center py-4 muted">
                    Submit a query to see results here.
                </div>
                <div class="table-responsive d-none" id="results-wrap">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Label</th>
                                <th>Audio ID</th>
                                <th>Probability</th>
                            </tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <p class="footer small">© 2025 Taptic • Audio Fingerprinting Demo</p>
    </main>

    <!-- JS -->
    <script>
        const ENDPOINT_UPLOAD = "/upload";
        const ENDPOINT_PREDICT = "/predict";

        const formLib = document.getElementById("form-library");
        const formQry = document.getElementById("form-query");
        const fileLib = document.getElementById("file-library");
        const fileQry = document.getElementById("file-query");
        const labelLib = document.getElementById("label-library");
        const alertLib = document.getElementById("alert-library");
        const alertQry = document.getElementById("alert-query");
        const resultsWrap = document.getElementById("results-wrap");
        const resultsBody = document.getElementById("results-body");
        const emptyState = document.getElementById("empty-state");

        const dzLib = document.getElementById("dz-library");
        const dzQry = document.getElementById("dz-query");

        // New: query status UI pieces
        const queryStatus = document.getElementById("query-status");
        const btnSubmitQuery = document.getElementById("btn-submit-query");
        const originalQueryBtnText = btnSubmitQuery.textContent;

        // Dropzones
        function setupDropzone(dzId, inputId) {
            const dz = document.getElementById(dzId);
            const input = document.getElementById(inputId);
            input.addEventListener("change", () => {
                const file = input.files?.[0];
                if (file) dz.textContent = file.name;
            });
            ["dragenter", "dragover"].forEach(evt => dz.addEventListener(evt, e => {
                e.preventDefault(); dz.classList.add("dragover");
            }));
            ["dragleave", "drop"].forEach(evt => dz.addEventListener(evt, e => {
                e.preventDefault(); dz.classList.remove("dragover");
            }));
            dz.addEventListener("drop", e => {
                const files = e.dataTransfer?.files;
                if (files?.length) { input.files = files; dz.textContent = files[0].name; }
            });
        }
        setupDropzone("dz-library", "file-library");
        setupDropzone("dz-query", "file-query");

        function showAlert(el, msg, type = "success") {
            el.className = `alert alert-${type} mt-3`;
            el.textContent = msg;
        }

        function renderResults(results) {
            resultsBody.innerHTML = "";
            if (!results || !Array.isArray(results.results) || results.results.length === 0) {
                resultsWrap.classList.add("d-none");
                emptyState.classList.remove("d-none");
                return;
            }
            emptyState.classList.add("d-none");
            resultsWrap.classList.remove("d-none");
            results.results
                .sort((a, b) => (b.probability ?? 0) - (a.probability ?? 0))
                .forEach((r, i) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
            <td>${i + 1}</td>
            <td>${r.label ?? "(unknown)"}</td>
            <td>${r.audio_id ?? ""}</td>
            <td>${typeof r.probability === "number" ? r.probability.toFixed(5) : ""}</td>
          `;
                    resultsBody.appendChild(row);
                });
        }

        // Upload to library (reload to refresh Jinja list)
        formLib.addEventListener("submit", async e => {
            e.preventDefault();
            const file = fileLib.files?.[0];
            if (!file) return showAlert(alertLib, "Please choose an audio file.", "warning");
            const fd = new FormData();
            fd.append("audio", file);
            if (labelLib && labelLib.value) fd.append("label", labelLib.value);

            try {
                const res = await fetch(ENDPOINT_UPLOAD, { method: "POST", body: fd });
                if (!res.ok) throw new Error();
                await res.json();
                showAlert(alertLib, "Saved. Reloading...", "success");
                window.location.reload();
            } catch {
                showAlert(alertLib, "Upload failed.", "danger");
            }
        });

        // Helper to toggle query loading UI
        function setQueryLoading(isLoading) {
            if (isLoading) {
                // show banner
                queryStatus.classList.remove("d-none");
                // disable button and show spinner inside
                btnSubmitQuery.disabled = true;
                btnSubmitQuery.innerHTML = `
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Submitting...
        `;
            } else {
                queryStatus.classList.add("d-none");
                btnSubmitQuery.disabled = false;
                btnSubmitQuery.textContent = originalQueryBtnText;
            }
        }

        // Run query (shows waiting indicator)
        formQry.addEventListener("submit", async e => {
            e.preventDefault();
            const file = fileQry.files?.[0];
            if (!file) return showAlert(alertQry, "Please choose a query audio file.", "warning");

            const fd = new FormData();
            fd.append("audio", file);

            try {
                setQueryLoading(true);
                const res = await fetch(ENDPOINT_PREDICT, { method: "POST", body: fd });
                if (!res.ok) throw new Error();
                const json = await res.json();
                showAlert(alertQry, "Query processed.", "success");
                renderResults(json);
            } catch {
                showAlert(alertQry, "Query failed.", "danger");
            } finally {
                setQueryLoading(false);
            }
        });

        document.getElementById("btn-clear-results").addEventListener("click", () => {
            renderResults({ results: [] });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>